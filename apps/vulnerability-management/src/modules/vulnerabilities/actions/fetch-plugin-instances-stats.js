import moment from 'moment';

import { vulnInstancesArrayPreprocessor } from 'tio-vm/modules/vulnerabilities/utils';
import { STANDARD_API_ACTION } from 'tio-alloy';
import { getTimeRangeFilterParams } from 'tio-vm/modules/common/utils/adv-search';
import { DAYS, timePeriod } from 'tio-vm/modules/common/constants';

import {
    PLUGIN_INSTANCES_STATS_REQUEST,
    PLUGIN_INSTANCES_STATS_SUCCESS,
    PLUGIN_INSTANCES_STATS_ERROR
} from './types';

export const fetchPluginInstancesStats = (pluginId, range = 0, filters = '') => {
    const { TWO_WEEKS, THIRTY_DAYS } = timePeriod;
    const vulnUrl = `/workbenches/vulnerabilities/${pluginId}/outputs?date_range=${range}`;
    const rangeFilter = { filterName: 'tracking.first_found' };

    // 0 -14 days
    rangeFilter.endDate = moment().add(1, DAYS);
    rangeFilter.duration = TWO_WEEKS + 2;
    const zeroToFourteenDaysRangeFilter = getTimeRangeFilterParams(filters, rangeFilter);
    // 15 -30 days
    rangeFilter.endDate = moment().subtract(TWO_WEEKS, DAYS);
    rangeFilter.duration = TWO_WEEKS + 3;
    const fifteenToThirtyDaysRangeFilter = getTimeRangeFilterParams(filters, rangeFilter);
    // 31 - 60 days
    rangeFilter.endDate = moment().subtract(THIRTY_DAYS, DAYS);
    rangeFilter.duration = THIRTY_DAYS + 1;
    const thirtyOneToSixtyDaysFilter = getTimeRangeFilterParams(filters, rangeFilter);
    // 61 - 90 days
    rangeFilter.endDate = moment().subtract(THIRTY_DAYS * 2, DAYS);
    const sixtyOneToNinetyDaysRangeFilter = getTimeRangeFilterParams(filters, rangeFilter);
    // 90+ days
    rangeFilter.endDate = moment().subtract(THIRTY_DAYS * 3, DAYS);
    rangeFilter.duration = '';
    const beyondThreeMonthRangeFilter = getTimeRangeFilterParams(filters, rangeFilter);

    return {
        type: STANDARD_API_ACTION,
        meta: {
            types: [
                PLUGIN_INSTANCES_STATS_REQUEST,
                PLUGIN_INSTANCES_STATS_SUCCESS,
                PLUGIN_INSTANCES_STATS_ERROR
            ],
            processResponseBeforeDispatch: vulnInstancesArrayPreprocessor,
            request: [
                { url: `${vulnUrl}${beyondThreeMonthRangeFilter}` },
                { url: `${vulnUrl}${sixtyOneToNinetyDaysRangeFilter}` },
                { url: `${vulnUrl}${thirtyOneToSixtyDaysFilter}` },
                { url: `${vulnUrl}${fifteenToThirtyDaysRangeFilter}` },
                { url: `${vulnUrl}${zeroToFourteenDaysRangeFilter}` }

            ]
        }
    };
};
