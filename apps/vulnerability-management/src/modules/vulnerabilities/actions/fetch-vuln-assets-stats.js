import { STANDARD_API_ACTION } from 'tio-alloy';
import { appendFilter, createFilter } from 'tio-vm/modules/common/utils/adv-search';

import {
    VULN_ASSETS_STATS_REQUEST,
    VULN_ASSETS_STATS_SUCCESS,
    VULN_ASSETS_STATS_ERROR
} from './types';

export const fetchVulnAssetsStats = (range = 0, filters = '') => {
    const url = `/workbenches/assets/vulnerabilities?date_range=${range}`;

    const malwareFilters =
        appendFilter(filters, createFilter('plugin.attributes.exploited_by_malware', 'eq', true));
    const frameworkFilters =
        appendFilter(filters, createFilter('plugin.attributes.exploit_framework_canvas', 'eq', true));
    const remoteFilters =
        appendFilter(filters, createFilter('plugin.attributes.cvss3_vector.raw', 'match', 'AV:N, AV:A'));
    const localFilters =
        appendFilter(filters, createFilter('plugin.attributes.cvss3_vector.raw', 'match', 'AV:L'));

    return {
        type: STANDARD_API_ACTION,
        meta: {
            types: [
                VULN_ASSETS_STATS_REQUEST,
                VULN_ASSETS_STATS_SUCCESS,
                VULN_ASSETS_STATS_ERROR
            ],
            request: [
                { url: `${url}${malwareFilters}` },
                { url: `${url}${frameworkFilters}` },
                { url: `${url}${remoteFilters}` },
                { url: `${url}${localFilters}` }
            ]
        }
    };
};
